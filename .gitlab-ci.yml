default:
  # The image was generated with the following Dockerfile:
  #
  # FROM ubuntu:19.04
  # RUN apt-get update && \
  #     apt-get upgrade -y && \
  #     apt-get install -y --no-install-recommends \
  #         autoconf automake libtool pkg-config \
  #         gcc clang make \
  #         python-dev zlib1g-dev liblzma-dev
  image: registry.gitlab.gnome.org/gnome/libxml2

.test:
  script:
    - sh autogen.sh $CONFIG
    - make -j$(nproc) V=1
    - make check

gcc:
  extends: .test
  variables:
    CFLAGS: "-O2 -std=c89 -D_XOPEN_SOURCE=700 -Werror"

clang:asan:
  extends: .test
  variables:
    CONFIG: "--without-python"
    CC: clang
    CFLAGS: "-O2 -g -fno-omit-frame-pointer -fsanitize=address,undefined -fno-sanitize=pointer-overflow -fno-sanitize-recover=all -Werror -Wno-error=cast-align"
    UBSAN_OPTIONS: "print_stacktrace=1"

clang:msan:
  extends: .test
  variables:
    CONFIG: "--without-python --without-zlib --without-lzma"
    CC: clang
    CFLAGS: "-O2 -g -fno-omit-frame-pointer -fsanitize=memory -Werror -Wno-error=cast-align"

